<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>yksp by groundupworks</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">yksp</h1>
        <p class="header">let &#39;em test &#39;emselves</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/groundupworks/yksp/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/groundupworks/yksp/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/groundupworks/yksp">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/groundupworks">groundupworks</a></p>


      </header>
      <section>
        <p>A fully Python-based tool that helps you automate Android UI testing and captures everything you need from each test session.</p>

<ul>
<li>Generation of UI events independent of device screen sizes</li>
<li>Validation of UI elements with PyUnit assertions</li>
<li>Screenshots and dumps of their matching view tree</li>
<li>Logcat output for the duration of each test</li>
<li>App data dump after each test, including preferences and databases</li>
<li>Backup file that can be used to restore your device state from each test</li>
<li>Execution of tests on all connected devices in parallel</li>
<li>Device properties dump, including the device model and installed Android version</li>
</ul>

<p>You can see yksp in action <a href="https://www.facebook.com/video.php?v=688024157960505">here</a>. Higher abstractions of UI interactions used to compose test scripts are available through <a href="https://github.com/dtmilano/AndroidViewClient">AndroidViewClient</a> by <a href="https://github.com/dtmilano" class="user-mention">@dtmilano</a>. This project will focus on tools to inspect, correlate, and validate the set of generated test results. Pull requests are, of course, welcome.</p>

<h2>
<a id="getting-set-up" class="anchor" href="#getting-set-up" aria-hidden="true"><span class="octicon octicon-link"></span></a>Getting set up</h2>

<p>This assumes your environment has <code>python</code>, <code>easy_install</code> and <code>git</code>. You may confirm each installation by typing the following commands in your Terminal.</p>

<pre><code>$ which python
$ which easy_install
$ which git
</code></pre>

<h3>
<a id="step-one" class="anchor" href="#step-one" aria-hidden="true"><span class="octicon octicon-link"></span></a>step one</h3>

<p>You may skip this step if you already have the <strong>Android SDK</strong> installed.</p>

<p>Download the <a href="http://developer.android.com/sdk/index.html">Android SDK</a>. You may download the stand-alone package for your platform instead of the IDE bundles. After extracting the package, you need to download the following tools, as they are not included in the SDK package.</p>

<ol>
<li>Android SDK Tools</li>
<li>Android SDK Platform-tools</li>
<li>Android SDK Build-tools</li>
</ol>

<p>You will download these tools by using yet another tool, which is included in the SDK package. Replace <code>android-sdk-root</code> with the local path to your extracted SDK root directory.</p>

<pre><code>$ cd android-sdk-root/tools
$ ./android list sdk --all
$ ./android update sdk --no-ui --all --filter 1,2,3
</code></pre>

<h3>
<a id="step-two" class="anchor" href="#step-two" aria-hidden="true"><span class="octicon octicon-link"></span></a>step two</h3>

<p>Install <strong>Pillow</strong> and <strong>AndroidViewClient</strong>.</p>

<pre><code>$ cd ~
$ sudo easy_install --upgrade Pillow
$ sudo easy_install --upgrade androidviewclient
</code></pre>

<h3>
<a id="step-three" class="anchor" href="#step-three" aria-hidden="true"><span class="octicon octicon-link"></span></a>step three</h3>

<p>Clone the <strong>yksp</strong> repo, and <strong>AndroidViewClient</strong> as a submodule.</p>

<pre><code>$ git clone git://github.com/groundupworks/yksp.git
$ cd yksp
$ git submodule init
$ git submodule update
</code></pre>

<h3>
<a id="step-four" class="anchor" href="#step-four" aria-hidden="true"><span class="octicon octicon-link"></span></a>step four</h3>

<p>Set the environment variable <code>$YKSP_HOME</code>, and also <code>$ANDROID_HOME</code> if not already set. Then configure your <code>$PATH</code>.</p>

<p>On a Mac</p>

<pre><code>$ sudo nano ~/.bash_profile
</code></pre>

<p>On Ubuntu</p>

<pre><code>$ sudo nano /etc/profile.d/yksp.sh
</code></pre>

<p>Add the following text, replacing <code>android-sdk-root</code>, <code>yksp-root</code>, and <code>build-tools-version</code> with your local paths. Log out and log back in.</p>

<pre><code>export ANDROID_HOME=android-sdk-root
export YKSP_HOME=yksp-root/yksp
export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/build-tools-version:$YKSP_HOME
</code></pre>

<p>Mine looks something like this on the Mac.</p>

<pre><code>export ANDROID_HOME=/Users/benedict/Dev/android-sdk-macosx
export YKSP_HOME=/Users/benedict/Dev/projects/yksp/yksp
export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/20.0.0:$YKSP_HOME
</code></pre>

<p>And... you're all set!</p>

<h2>
<a id="running-the-example" class="anchor" href="#running-the-example" aria-hidden="true"><span class="octicon octicon-link"></span></a>Running the example</h2>

<p>The yksp repo has an <code>examples/flying-photo-booth-tests</code> folder, containing the <a href="https://play.google.com/store/apps/details?id=com.groundupworks.flyingphotobooth">Flying PhotoBooth</a> APK, along with its PyUnit test scripts in a <code>scripts</code> folder. Connect one or more Android devices to your computer. Ensure that the device is made USB debuggable and screen lock is disabled (like, completely off... not even Swipe Unlock). This is how you would run a typical yksp test session.</p>

<pre><code>$ cd $YKSP_HOME/../examples/flying-photo-booth-tests
$ yksp
</code></pre>

<p>Oberserve the test session logs in your Terminal, it should look as follow if everything is set up properly. Results are stored in the newly created <code>results</code> folder, with each test session in a folder named with its own timestamp.</p>

<pre><code>$ yksp
Scanning for APK...
APK: flying-photo-booth-release.apk
Inspecting APK...
Package name: com.groundupworks.flyingphotobooth
Version name: 3.4
Version code: 13
Scanning for test scripts...
Script 1: testAbandonLinking.py
Script 2: testCapture.py
Listing devices...
Device 1: EP7309229R
[EP7309229R] Collecting device properties...
[EP7309229R] [ro.product.manufacturer]: [Sony]
[EP7309229R] [ro.product.model]: [C6502]
[EP7309229R] [ro.build.version.sdk]: [16]

[EP7309229R] Installing APK...
[EP7309229R] Preparing test case 1 of 2 [testAbandonLinking.py] on C6502...
[EP7309229R] Wiping app data...
[EP7309229R] Clearing logcat buffer...
[EP7309229R] Start printing logcat output to file...
[EP7309229R] Executing [testAbandonLinking.py] with command:
python results/2014-09-24-09-34-28/C6502-[EP7309229R]/testAbandonLinking/testAbandonLinking.py --package com.groundupworks.flyingphotobooth --serial EP7309229R --root results/2014-09-24-09-34-28/C6502-[EP7309229R]/testAbandonLinking --logs pyunit.txt --screenshots screenshots --screendumps screendumps
[EP7309229R] Logcat output saved
[EP7309229R] Downloading app data from device...
[EP7309229R] Extracting app data...

1947+0 records in
1947+0 records out
1947 bytes transferred in 0.002251 secs (864984 bytes/sec)
x apps/com.groundupworks.flyingphotobooth/_manifest
x apps/com.groundupworks.flyingphotobooth/db/webviewCookiesChromiumPrivate.db
x apps/com.groundupworks.flyingphotobooth/db/wings.db-journal
x apps/com.groundupworks.flyingphotobooth/db/wings.db
x apps/com.groundupworks.flyingphotobooth/db/webviewCookiesChromium.db
x apps/com.groundupworks.flyingphotobooth/sp/com.facebook.SharedPreferencesTokenCachingStrategy.DEFAULT_KEY.xml
x apps/com.groundupworks.flyingphotobooth/sp/com.groundupworks.flyingphotobooth_preferences.xml

[EP7309229R] App data downloaded
[EP7309229R] Wiping app data...
[EP7309229R] Preparing test case 2 of 2 [testCapture.py] on C6502...
[EP7309229R] Wiping app data...
[EP7309229R] Clearing logcat buffer...
[EP7309229R] Start printing logcat output to file...
[EP7309229R] Executing [testCapture.py] with command:
python results/2014-09-24-09-34-28/C6502-[EP7309229R]/testCapture/testCapture.py --package com.groundupworks.flyingphotobooth --serial EP7309229R --root results/2014-09-24-09-34-28/C6502-[EP7309229R]/testCapture --logs pyunit.txt --screenshots screenshots --screendumps screendumps
[EP7309229R] Logcat output saved
[EP7309229R] Downloading app data from device...
[EP7309229R] Extracting app data...

567+0 records in
567+0 records out
567 bytes transferred in 0.000659 secs (860409 bytes/sec)
x apps/com.groundupworks.flyingphotobooth/_manifest

[EP7309229R] App data downloaded
[EP7309229R] Wiping app data...
[EP7309229R] Uninstalling application...
All 2 test scripts executed on 1 device in 93 seconds
</code></pre>

<h3>
<a id="what-just-happened" class="anchor" href="#what-just-happened" aria-hidden="true"><span class="octicon octicon-link"></span></a>what just happened?</h3>

<p>The test session logs should give a pretty good idea of what yksp is doing, but here is a better view.</p>

<pre><code>Find APK from your root directory
Find test scripts from the scripts folder
Find connected devices and write serials to serials.txt
For each device, run in parallel:
    Collect device properties and write to device.txt
    Install APK
    For each test script:
        Make a local copy of the test script
        Wipe app data
        Start logcat
        Execute local copy of the test script:
            Connect to and wake device in YkspTestCase.setUp()
            Run each test...() method in your YkspTestCase subclass:
                For each YkspTestCase.saveScreen() call:
                    Save screenshot to the screenshots folder
                    Save view tree dump to screendumps folder 
            Kill app in YkspTestCase.tearDown()
            Write PyUnit test results to pyunit.txt
        Stop logcat and write to logcat.txt
        Dump app data to data.ab
        Extract data.ab to data folder
        Wipe app data
    Uninstall application
Report completion of test session
</code></pre>

<h3>
<a id="where-are-my-results" class="anchor" href="#where-are-my-results" aria-hidden="true"><span class="octicon octicon-link"></span></a>where are my results?</h3>

<p>Test results are organized in a directory structure that would allow a script to easily walk the tree and generate reports from a data set involving multiple devices and test sessions.</p>

<pre><code>results
    &lt;DATETIME&gt;
        serials.txt
        SERIAL-[MODEL]
            device.txt
            SCRIPT1
                SCRIPT1.py
                pyunit.txt
                logcat.txt
                data.ab
                data
                    ...
                screenshots
                    0-tag0.png
                    1-tag1.png
                    2-tag2.png
                screendumps
                    0-tag0.txt
                    1-tag1.txt
                    2-tag2.txt
            SCRIPT2
                SCRIPT2.py
                pyunit.txt
                logcat.txt
                data.ab
                data
                    ...
                screenshots
                    0-tag3.png
                    1-tag4.png
                screendumps
                    0-tag3.txt
                    1-tag4.txt
</code></pre>

<h2>
<a id="creating-test-scripts" class="anchor" href="#creating-test-scripts" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating test scripts</h2>

<p>Test scripts define subclasses of <code>YkspTestCase</code> based on the <a href="https://wiki.python.org/moin/PyUnit">PyUnit</a> framework. You will define and implement one or more methods with names starting with <code>test</code>, like such <code>def testSomething(self):</code>. To figure out what goes in the implementation, a good way to start is to look at <a href="https://github.com/groundupworks/yksp/blob/master/examples/flying-photo-booth-tests/scripts/testCapture.py">testCapture.py</a> and <a href="https://github.com/groundupworks/yksp/blob/master/examples/flying-photo-booth-tests/scripts/testAbandonLinking.py">testAbandonLinking.py</a> in <code>examples/flying-photo-booth-tests/scripts</code>.</p>

<p>From the examples, you will find that the <code>YkspTestCase</code> class provides the following convenience methods, documented <a href="https://github.com/groundupworks/yksp/blob/master/yksp/yksptestcase.py">here</a>.</p>

<div class="highlight highlight-python"><pre>launchApp(<span class="pl-vpf">package</span><span class="pl-k">=</span><span class="pl-c1">None</span>)
refreshScreen(<span class="pl-vpf">sleep</span><span class="pl-k">=</span><span class="pl-c1">1</span>)
saveScreen(<span class="pl-vpf">tag</span><span class="pl-k">=</span><span class="pl-c1">None</span>, <span class="pl-vpf">sleep</span><span class="pl-k">=</span><span class="pl-c1">1</span>)</pre></div>

<p>It is important that <code>refreshScreen()</code> or <code>saveScreen()</code> be called after each screen transition on your device, in order for the test to pick up the updated view tree.</p>

<p>To send UI events to your device, we rely on <a href="https://github.com/dtmilano/AndroidViewClient">AndroidViewClient</a> by <a href="https://github.com/dtmilano" class="user-mention">@dtmilano</a>. You have already downloaded the documentaion to here <code>$YKSP_HOME/../AndroidViewClient/AndroidViewClient/doc/index.html</code> as part of the submodule.</p>

<p>To pass or fail test cases, aside from visual inspection of screenshots, we mostly rely on exceptions raised by the <code>findView...()</code> methods from AndroidViewClient, as well as the family of <code>assert...()</code> methods available through the PyUnit framework.</p>

<p>When writing test scripts, while you can find certain views by text sometimes, you will encounter UI elements like an image button, which you need to identify by a unique ID in the view tree. This is when the <code>dump</code> tool in AndroidViewClient becomes handy. Just manually navigate to the screen on your connected device, then type that in Terminal and pick out the ID you need from the view tree.</p>

<pre><code>$ dump
android.widget.FrameLayout id/no_id/1 
   android.widget.LinearLayout id/no_id/2 
      android.widget.FrameLayout id/no_id/3 
         android.widget.FrameLayout id/no_id/4 
            android.widget.FrameLayout id/no_id/5 
               android.widget.FrameLayout id/no_id/6 
                  android.widget.LinearLayout id/no_id/7 
                     android.widget.RelativeLayout id/no_id/8 
                        android.widget.TextView id/no_id/9 PHOTO 1 OF 2
                        android.widget.ImageButton id/no_id/10 
                        android.widget.ImageButton id/no_id/11 
                     android.widget.RelativeLayout id/no_id/12 
                        android.view.View id/no_id/13 
                           android.view.View id/no_id/14 
                           android.view.View id/no_id/15 
                           android.view.View id/no_id/16 
                        android.widget.Button id/no_id/17 CAPTURE
</code></pre>

<p>Lastly, it is important to remember that while an app data wipe is performed before and after running each test script to remove the persistent data stored, that is not the case in between test methods within the same script. Instead, the app is killed between test methods, which means in-memory states are destroyed, but disk-persisted states are carried across. For each test to have a true 'fresh start', it is recommended that you separate out your tests into different files, with only a single test method in each <code>YkspTestCase</code> subclass.</p>

<p>After all that, here is a template to get you started!</p>

<div class="highlight highlight-python"><pre><span class="pl-c">#! /usr/bin/env python</span>
<span class="pl-k">import</span> sys
<span class="pl-k">import</span> os

<span class="pl-k">try</span>:
    sys.path.append(os.environ[<span class="pl-s1"><span class="pl-pds">'</span>YKSP_HOME<span class="pl-pds">'</span></span>])
<span class="pl-k">except</span>:
    <span class="pl-k">pass</span>

<span class="pl-k">from</span> yksptestcase <span class="pl-k">import</span> YkspTestCase

<span class="pl-st">class</span> <span class="pl-en">MyTestCase</span>(<span class="pl-e">YkspTestCase</span>):

    <span class="pl-st">def</span> <span class="pl-en">testSomething</span>(<span class="pl-vpf">self</span>):
        <span class="pl-s1"><span class="pl-pds">'''</span></span>
<span class="pl-s1">        Tests something... like geese, mustard, cabbages and kings.</span>
<span class="pl-s1">        <span class="pl-pds">'''</span></span>
        <span class="pl-v">self</span>.launchApp()
        <span class="pl-v">self</span>.saveScreen(<span class="pl-s1"><span class="pl-pds">'</span>my-start-screen<span class="pl-pds">'</span></span>, <span class="pl-vpf">sleep</span><span class="pl-k">=</span><span class="pl-c1">1</span>)

        <span class="pl-c"># Your implementation...</span>


<span class="pl-k">if</span> <span class="pl-sv">__name__</span> <span class="pl-k">==</span> <span class="pl-s1"><span class="pl-pds">'</span>__main__<span class="pl-pds">'</span></span>:
    YkspTestCase.main(sys.argv)</pre></div>

<h2>
<a id="run-options" class="anchor" href="#run-options" aria-hidden="true"><span class="octicon octicon-link"></span></a>Run options</h2>

<p>yksp has run options to support various use cases. You can see those by entering the following in your Terminal. </p>

<pre><code>$ yksp --help

Usage:
-h, --help               OPTIONAL    print this help and exit
-l, --linear             OPTIONAL    run tests on one device after another
-a, --noapk &lt;package&gt;    OPTIONAL    disable APK installation and run tests using the pre-installed application with the specified package name
-d, --nodump             OPTIONAL    disable app data dump after executing each test script
</code></pre>

<h3>
<a id="--linear" class="anchor" href="#--linear" aria-hidden="true"><span class="octicon octicon-link"></span></a>--linear</h3>

<p>By default, yksp spawns multiple processes to execute test scripts on all connected devices in parallel. You may force yksp to run the scripts on one device after another using this flag. It is useful when debugging your test scripts, since the test logs in your Terminal will look cleaner.</p>

<p>Note that this does not imply everything is executed in a single process, as yksp uses multiple processes to do everything it needs to do even for a single device.</p>

<h3>
<a id="--noapk" class="anchor" href="#--noapk" aria-hidden="true"><span class="octicon octicon-link"></span></a>--noapk</h3>

<p>This option allows launching off a pre-installed application, specified by its package name. No APK needs to be provided, and yksp will ignore any APK in your directory and skip installation (and uninstallation) altogether. A verification step is performed on each connected device to verify that the application is already installed, and the test scripts will be executed only on the subset of devices that are verified.</p>

<p>This option is useful for integrating yksp with your IDE for development. In Android Studio, you can have your <strong>Run Configurations</strong> deploy the APK but not launch any Activity, and instead launch an external tool with the following configurations, where <code>com.groundupworks.flyingphotobooth</code> is replaced by the package name of your app, and <code>some-directory</code> is any directory containing a <code>scripts</code> folder containing your test scripts.</p>

<pre><code>Program:           yksp
Parameters:        --noapk com.groundupworks.flyingphotobooth
Working directory: some-directory
</code></pre>

<h3>
<a id="--nodump" class="anchor" href="#--nodump" aria-hidden="true"><span class="octicon octicon-link"></span></a>--nodump</h3>

<p>After executing each test script, yksp utilizes the <code>adb backup</code> command to generate the backup file <code>data.ab</code>. The file itself can be used to restore the device state, as it contains all the locally persisted app data, including preferences and databases. yksp also extracts the file into the <code>data</code> folder, which you can conveniently use to validate the state changes as a result of the test script.</p>

<p>Note that if the application manifest has <code>android:allowBackup="false"</code>, a <code>data.ab</code> file will be dumped out containing nothing. This is the correct behaviour and the absence of files in the extracted folder can be used to validate this.</p>

<p>The data dump is usually fast, but can optionally be disabled with this flag.</p>

<h2>
<a id="mildly-faq" class="anchor" href="#mildly-faq" aria-hidden="true"><span class="octicon octicon-link"></span></a>Mildly-faq</h2>

<h4>
<a id="q-can-my-pyunit-test-script-mock-out-components-in-my-application-as-part-of-the-test" class="anchor" href="#q-can-my-pyunit-test-script-mock-out-components-in-my-application-as-part-of-the-test" aria-hidden="true"><span class="octicon octicon-link"></span></a>
<strong>Q:</strong> Can my PyUnit test script mock out components in my application as part of the test?</h4>

<p><strong>A:</strong> The short answer is no. yksp tests an APK, or a pre-installed app, as is. It cannot inject classes into your application, or switch up any build-time configurations. It doesn't mock parts of your application; it mocks you. One way around this limitation is to build the mock components into your APK, make the build-time configurations into run-time configurations, then use UI toggles or a special launch Intent to invoke a code path utilizing the mock components.</p>

<h4>
<a id="q-how-can-i-pass-or-fail-my-tests-based-on-user-generated-events-that-dont-result-in-ui-implications" class="anchor" href="#q-how-can-i-pass-or-fail-my-tests-based-on-user-generated-events-that-dont-result-in-ui-implications" aria-hidden="true"><span class="octicon octicon-link"></span></a>
<strong>Q:</strong> How can I pass or fail my tests based on 'user-generated' events that don't result in UI implications?</h4>

<p><strong>A:</strong> Again, yksp mocks out the user. Within the PyUnit test method, this mock user can generate events as input, and inspect the UI elements to validate the visible part of the output. However, input events can also result in output not  immediately visible through the UI, such as a state change:</p>

<ul>
<li>of an in-memory variable</li>
<li>in locally persisted preferences or databases</li>
<li>on a remote server</li>
</ul>

<p>The first one is irrelevant, unless there is a way to confirm it through the UI. If a human is to validate the second and third cases, it would be via a database dump, check some server state via a server API call, or in some cases, inspection of the logcat output may be sufficient. Although it is possible to do all of the above within the test case itself and do assertion, using regular Python and adb commands, the recommended way is to use the PyUnit assertions to validate only the UI.</p>

<p>Since yksp dumps out the locally persisted app data and the logcat output after running each test script, just make use of those! Look at the results of the many test sessions as your data set, of which the PyUnit results is only one of the many components. You can write scripts to validate state changes, compare view trees and generate image similarity indices, correlate results across different devices and test sessions, and generate reports that are more comprehensive and meaningful.</p>

<h4>
<a id="q-why-is-the-name-weird" class="anchor" href="#q-why-is-the-name-weird" aria-hidden="true"><span class="octicon octicon-link"></span></a>
<strong>Q:</strong> Why is the name weird?</h4>

<p><strong>A:</strong> Maybe because it consists entirely of consonants? Although the <em>y</em> is debatable.</p>
      </section>
      <footer>
        <p><small>Hosted on <a href="http://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
